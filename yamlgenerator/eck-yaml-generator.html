<!doctype html>
<html>
    <head>
        <title>ECK Elasticsearch Cluster YAML Generator</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
            body {
                background: #0B64DD;
                font-family: system-ui;
                color: #333;
                margin: 0;
            }
            h1 {
                text-align: center;
                color: #f4f6f8;
                margin: 20px 0;
            }
            .container {
                background: white;
                padding: 20px;
                margin: 20px auto;
                border-radius: 8px;
                max-width: 900px;
                box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.05);
            }
            h2,
            h3 {
                color: #333;
                margin-top: 0;
            }
            label {
                display: block;
                margin-bottom: 6px;
                font-size: 0.95em;
                font-weight: 500;
            }
            input,
            select,
            textarea,
            button {
                width: 100%;
                padding: 8px;
                margin-bottom: 12px;
                border-radius: 5px;
                border: 1px solid #ccc;
                font-size: 1em;
                background: #fff;
                box-sizing: border-box;
                transition:
                    border-color 0.2s ease,
                    background-color 0.2s ease;
            }
            input:focus,
            select:focus,
            textarea:focus {
                border-color: #0366d6;
                outline: none;
                background: #fefefe;
            }
            button {
                cursor: pointer;
                border: none;
                font-weight: 500;
                transition:
                    background-color 0.2s ease,
                    transform 0.1s ease;
            }
            button:hover {
                transform: translateY(-1px);
            }
            .remove-btn {
                background: #E55940;
                color: black;
            }
            .copy-btn {
                background: #ff9800;
                color: white;
            }
            .add-btn {
                background: #e0e0e0;
                color: #333;
            }
            button.primary {
                background-color: #153385;
                color: white;
            }
            button.primary:hover {
                background-color: #154385;
            }
            .kv-pair {
                display: flex;
                gap: 6px;
                margin-bottom: 6px;
                align-items: center;
            }
            .kv-pair input {
                flex: 1;
            }
            .kv-pair .remove-btn {
                flex: 0 0 auto;
                width: 30px;
                padding: 0;
                height: 32px;
                font-size: 16px;
                text-align: center;
            }
            .roles-group {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-bottom: 12px;
            }
            .roles-group label {
                display: flex;
                align-items: center;
                gap: 4px;
                background: #f7f7f7;
                padding: 4px 6px;
                border-radius: 4px;
            }
            .remote-cluster {
                border: 1px dashed #ccc;
                padding: 8px;
                margin-bottom: 8px;
                border-radius: 4px;
                background: #fafafa;
            }
            pre {
                background: #1e1e1e;
                color: #dcdcdc;
                font-size: 0.9em;
                border-radius: 6px;
                padding: 15px;
                white-space: pre-wrap;
                overflow-x: auto;
            }
            /* Accordion style for details */
            details {
                border: 1px solid #ddd;
                border-radius: 6px;
                padding: 6px 10px;
                background: #fafafa;
                margin-bottom: 12px;
            }
            details summary {
                cursor: pointer;
                font-weight: 600;
            }
            @media (min-width: 768px) {
                .form-row {
                    display: flex;
                    gap: 10px;
                }
                .form-row > div {
                    flex: 1;
                }
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
        <script>
            const ALL_ROLES = [
                "master",
                "data",
                "data_content",
                "data_hot",
                "data_warm",
                "data_cold",
                "data_frozen",
                "ingest",
                "ml",
                "remote_cluster_client",
                "transform",
            ];
            function addKVRow(containerId, keyVal = { key: "", val: "" }) {
                const container = document.getElementById(containerId);
                const div = document.createElement("div");
                let keyPH = "Key";
                let valPH = "Value";
                if (containerId.includes("_env")) {
                    keyPH = "ES_JAVA_OPTS";
                    valPH = "-Xms2g -Xmx2g";
                }
                div.className = "kv-pair";
                div.innerHTML = `<input name="${containerId}_key" placeholder="${keyPH}" value="${keyVal.key}" />
  <input name="${containerId}_val" placeholder="${valPH}" value="${keyVal.val}" />
  <button type="button" class="remove-btn" onclick="this.parentNode.remove()">x</button>`;
                container.appendChild(div);
            }
            function addRemoteCluster(data = { name: "", namespace: "" }) {
                const container = document.getElementById("remoteClusters");
                const idx =
                    container.querySelectorAll(".remote-cluster").length;
                const div = document.createElement("div");
                div.className = "remote-cluster";
                div.innerHTML = `
    <label>Remote Cluster Name</label>
    <input name="remoteClusters[${idx}][name]" value="${data.name}">
    <label>Remote Cluster Namespace</label>
    <input name="remoteClusters[${idx}][namespace]" value="${data.namespace}">
    <button type="button" class="remove-btn" onclick="this.parentNode.remove()">Remove</button>
  `;
                container.appendChild(div);
            }
            function addNodeSet(data) {
                const idx = document.querySelectorAll(".nodeSet").length;
                const container = document.getElementById("nodesets-container");
                const htmlBlock = `
<div class="nodeSet">
  <label>NodeSet Name</label>
  <input name="nodeSets[${idx}][name]" value="${data.name || ""}" required />
  <label>Node Count</label>
  <input type="number" min="1" name="nodeSets[${idx}][count]" value="${data.count || 1}" required />
  <label>Node Roles</label>
  <div class="roles-group">
    ${ALL_ROLES.map((r) => `<label><input type="checkbox" name="nodeSets[${idx}][roles]" value="${r}" ${data.roles && data.roles.includes(r) ? "checked" : ""}> ${r}</label>`).join("")}
  </div>
  <label>Extra Config (YAML)</label>
  <textarea name="nodeSets[${idx}][configYaml]">${data.configYaml || ""}</textarea>
  <details>
    <summary>⚙️ Advanced NodeSet Settings</summary>
    <label>Labels</label>
    <div id="ns${idx}_labels"></div>
    <button type="button" class="add-btn" onclick="addKVRow('ns${idx}_labels')">+ Add Label</button>
    <label>Annotations</label>
    <div id="ns${idx}_annotations"></div>
    <button type="button" class="add-btn" onclick="addKVRow('ns${idx}_annotations')">+ Add Annotation</button>
    <label>Node Selector</label>
    <div id="ns${idx}_nodeSelector"></div>
    <button type="button" class="add-btn" onclick="addKVRow('ns${idx}_nodeSelector')">+ Add Selector</button>
    <h3>Resources</h3>
    <label>CPU Request</label><input name="nodeSets[${idx}][cpuRequest]" placeholder="2" />
    <label>CPU Limit</label><input name="nodeSets[${idx}][cpuLimit]" placeholder="4" />
    <label>Memory Request</label><input name="nodeSets[${idx}][memRequest]" placeholder="2Gi" />
    <label>Memory Limit</label><input name="nodeSets[${idx}][memLimit]" placeholder="4Gi" />
    <h3>Storage</h3>
    <label>Storage Class</label><input name="nodeSets[${idx}][storageClass]" placeholder="standard" />
    <label>Storage Size</label><input name="nodeSets[${idx}][storageSize]" placeholder="30Gi" />
    <label>Container Environment Variables</label>
    <div id="ns${idx}_env"></div>
    <button type="button" class="add-btn" onclick="addKVRow('ns${idx}_env')">+ Add Environmental Variable</button>
  </details>
  <button type="button" class="remove-btn" onclick="this.closest('.nodeSet').remove()">Remove NodeSet</button>
</div>`;
                container.insertAdjacentHTML("beforeend", htmlBlock);
            }
            function kvPairsToDict(keys, vals) {
                const out = {};
                keys.forEach((k, i) => {
                    const key = k.trim();
                    if (key) out[key] = (vals[i] || "").trim();
                });
                return Object.keys(out).length ? out : null;
            }
            function kvPairsToEnv(keys, vals) {
                const out = [];
                keys.forEach((k, i) => {
                    const key = k.trim();
                    if (key)
                        out.push({ name: key, value: (vals[i] || "").trim() });
                });
                return out.length ? out : null;
            }
            function safeYamlLoad(s) {
                if (!s || !s.trim()) return null;
                try {
                    return jsyaml.load(s) || null;
                } catch {
                    return null;
                }
            }
function generateYAMLFromForm(formData) {
    const clusterLabels = kvPairsToDict(
        formData.getAll("clusterLabels_key"),
        formData.getAll("clusterLabels_val"),
    );
    const clusterAnnotations = kvPairsToDict(
        formData.getAll("clusterAnnotations_key"),
        formData.getAll("clusterAnnotations_val"),
    );
    const cluster = {
        apiVersion: "elasticsearch.k8s.elastic.co/v1",
        kind: "Elasticsearch",
        metadata: {
            name: formData.get("clusterName") || "elasticsearch",
        },
        spec: { version: formData.get("version") || "9.0.0" },
    };
    const ns = formData.get("namespace")?.trim();
    if (ns) cluster.metadata.namespace = ns;
    if (clusterLabels) cluster.metadata.labels = clusterLabels;
    if (clusterAnnotations) cluster.metadata.annotations = clusterAnnotations;
    const img = formData.get("image")?.trim();
    if (img) cluster.spec.image = img;
    const rcse = formData.get("remoteClusterServer")?.trim();
    if (rcse) cluster.spec.remoteClusterServer = { enabled: rcse === "true" };
    // ✅ Remote Clusters only if non-empty
    const rcsIdxs = [...formData.keys()]
        .filter((k) => k.startsWith("remoteClusters["))
        .map((k) => parseInt(k.split("[")[1]))
        .filter((v, i, a) => a.indexOf(v) === i);
    if (rcsIdxs.length) {
        const rcsArray = [];
        rcsIdxs.forEach((idx) => {
            const name = formData.get(`remoteClusters[${idx}][name]`)?.trim();
            const namespace = formData.get(`remoteClusters[${idx}][namespace]`)?.trim();
            if (name) {
                rcsArray.push({
                    elasticsearchRef: { name, namespace }
                });
            }
        });
        if (rcsArray.length) {
            cluster.spec.remoteClusters = rcsArray;
        }
    }
    const ssSecret = formData.get("secureSettingsSecret")?.trim();
    if (ssSecret) cluster.spec.secureSettings = [{ secretName: ssSecret }];
    const pdbMaxU = formData.get("pdbMaxUnavailable")?.trim();
    const pdbMinA = formData.get("pdbMinAvailable")?.trim();
    const pdbSelText = formData.get("pdbSelector")?.trim();
    if (pdbMaxU || pdbMinA || pdbSelText) {
        cluster.spec.podDisruptionBudget = { spec: {} };
        if (pdbMaxU) cluster.spec.podDisruptionBudget.spec.maxUnavailable = pdbMaxU;
        if (pdbMinA) cluster.spec.podDisruptionBudget.spec.minAvailable = pdbMinA;
        if (pdbSelText) cluster.spec.podDisruptionBudget.spec.selector = safeYamlLoad(pdbSelText);
    }
    const maxSurge = formData.get("updateMaxSurge")?.trim();
    const maxUnavailable = formData.get("updateMaxUnavailable")?.trim();
    if (maxSurge || maxUnavailable) {
        cluster.spec.updateStrategy = { changeBudget: {} };
        if (maxSurge) cluster.spec.updateStrategy.changeBudget.maxSurge = parseInt(maxSurge);
        if (maxUnavailable) cluster.spec.updateStrategy.changeBudget.maxUnavailable = parseInt(maxUnavailable);
    }
    const extraYaml = (formData.get("extraYaml") || "").trim();
    if (extraYaml) Object.assign(cluster.spec, safeYamlLoad(extraYaml) || {});
    const indices = [
        ...new Set(
            [...formData.keys()]
                .filter((k) => k.startsWith("nodeSets["))
                .map((k) => parseInt(k.split("[")[1])),
        ),
    ].sort((a, b) => a - b);
    const nodeSets = [];
    indices.forEach((idx) => {
        const nsLabels = kvPairsToDict(
            formData.getAll(`ns${idx}_labels_key`),
            formData.getAll(`ns${idx}_labels_val`),
        );
        const nsAnno = kvPairsToDict(
            formData.getAll(`ns${idx}_annotations_key`),
            formData.getAll(`ns${idx}_annotations_val`),
        );
        const nsSel = kvPairsToDict(
            formData.getAll(`ns${idx}_nodeSelector_key`),
            formData.getAll(`ns${idx}_nodeSelector_val`),
        );
        const envVars = kvPairsToEnv(
            formData.getAll(`ns${idx}_env_key`),
            formData.getAll(`ns${idx}_env_val`),
        );
        const roles = formData.getAll(`nodeSets[${idx}][roles]`);
        const nsObj = {
            name: formData.get(`nodeSets[${idx}][name]`),
            count: parseInt(formData.get(`nodeSets[${idx}][count]`) || "1"),
            config: { "node.roles": roles },
        };
        const extraCfg = (formData.get(`nodeSets[${idx}][configYaml]`) || "").trim();
        if (extraCfg) Object.assign(nsObj.config, safeYamlLoad(extraCfg) || {});
        const podMeta = {}, podSpec = {};
        if (nsLabels) podMeta.labels = nsLabels;
        if (nsAnno) podMeta.annotations = nsAnno;
        if (nsSel) podSpec.nodeSelector = nsSel;
        const cpuReq = formData.get(`nodeSets[${idx}][cpuRequest]`)?.trim();
        const cpuLim = formData.get(`nodeSets[${idx}][cpuLimit]`)?.trim();
        const memReq = formData.get(`nodeSets[${idx}][memRequest]`)?.trim();
        const memLim = formData.get(`nodeSets[${idx}][memLimit]`)?.trim();
        if (cpuReq || cpuLim || memReq || memLim) {
            const resources = {};
            if (cpuReq || memReq) {
                resources.requests = {};
                if (cpuReq) resources.requests.cpu = cpuReq;
                if (memReq) resources.requests.memory = memReq;
            }
            if (cpuLim || memLim) {
                resources.limits = {};
                if (cpuLim) resources.limits.cpu = cpuLim;
                if (memLim) resources.limits.memory = memLim;
            }
            podSpec.containers = podSpec.containers || [{}];
            podSpec.containers[0].resources = {
                ...podSpec.containers[0].resources,
                ...resources,
            };
        }
        if (envVars) {
            podSpec.containers = podSpec.containers || [{}];
            podSpec.containers[0].env = envVars;
        }
        if (Object.keys(podMeta).length || Object.keys(podSpec).length) {
            nsObj.podTemplate = {};
            if (Object.keys(podMeta).length) nsObj.podTemplate.metadata = podMeta;
            if (Object.keys(podSpec).length) nsObj.podTemplate.spec = podSpec;
        }
        const storageClass = formData.get(`nodeSets[${idx}][storageClass]`)?.trim();
        const storageSize = formData.get(`nodeSets[${idx}][storageSize]`)?.trim();
        if (storageClass || storageSize) {
            nsObj.volumeClaimTemplates = [
                {
                    metadata: { name: "elasticsearch-data" },
                    spec: {
                        accessModes: ["ReadWriteOnce"],
                        resources: {
                            requests: {
                                storage: storageSize || "30Gi",
                            },
                        },
                        storageClassName: storageClass || null,
                    },
                },
            ];
        }
        nodeSets.push(nsObj);
    });
    cluster.spec.nodeSets = nodeSets;
    return jsyaml.dump(cluster, {
        sortKeys: false,
        indent: 2,
        noArrayIndent: true
    });
}
            function copyYAML() {
                const yamlText =
                    document.getElementById("yaml-output-text").innerText;
                navigator.clipboard
                    .writeText(yamlText)
                    .then(() => alert("YAML copied!"))
                    .catch(() => alert("Failed to copy"));
            }
            function downloadYAML() {
                const yamlText =
                    document.getElementById("yaml-output-text").innerText;
                const blob = new Blob([yamlText], { type: "text/yaml" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "elasticsearch-cluster.yaml";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            document.addEventListener("DOMContentLoaded", () => {
                ["clusterLabels", "clusterAnnotations"].forEach((id) =>
                    addKVRow(id),
                );
                addRemoteCluster();
                addNodeSet({
                    name: "newnodeset",
                    count: 1,
                    roles: ["master", "data", "ingest"],
                    configYaml: "",
                });
                document
                    .getElementById("cluster-form")
                    .addEventListener("submit", (e) => {
                        e.preventDefault();
                        const formData = new FormData(e.target);
                        const yamlStr = generateYAMLFromForm(formData);
                        document.getElementById(
                            "yaml-output-container",
                        ).innerHTML = `
      <h3>YAML Output</h3>
      <button class='copy-btn' type='button' onclick='copyYAML()'>Copy YAML</button>
      <button class='primary' type='button' onclick='downloadYAML()'>Download YAML</button>
      <pre id='yaml-output-text'>${yamlStr}</pre>
    `;
                    });
            });
        </script>
    </head>
    <body>
        <h1>ECK Elasticsearch Cluster YAML Generator</h1>
        <form id="cluster-form">
            <div class="container">
                <h2>Cluster-wide Settings</h2>
                <div class="form-row">
                    <div>
                        <label>Cluster Name</label
                        ><input
                            name="clusterName"
                            value="elasticsearch"
                            required
                        />
                    </div>
                    <div>
                        <label>Namespace</label
                        ><input name="namespace" placeholder="default" />
                    </div>
                </div>
                <div class="form-row">
                    <div>
                        <label>Version</label
                        ><input name="version" value="9.0.0" required />
                    </div>
                </div>
                <label>Extra Cluster Config (YAML)</label
                ><textarea name="extraYaml"></textarea>
                <details>
                    <summary>⚙️ Advanced Cluster Settings</summary>
                    <label>Labels</label>
                    <div id="clusterLabels"></div>
                    <button
                        type="button"
                        class="add-btn"
                        onclick="addKVRow('clusterLabels')"
                    >
                        + Add Label
                    </button>
                    <label>Annotations</label>
                    <div id="clusterAnnotations"></div>
                    <button
                        type="button"
                        class="add-btn"
                        onclick="addKVRow('clusterAnnotations')"
                    >
                        + Add Annotation
                    </button>
                    <label>Image</label
                    ><input
                        name="image"
                        placeholder="docker.elastic.co/elasticsearch/elasticsearch:9.0.0"
                    />
                    <label>Secure Settings Secret Name</label
                    ><input
                        name="secureSettingsSecret"
                        placeholder="my-secret"
                    />
                    <label>Pod Disruption Budget - Max Unavailable</label
                    ><input name="pdbMaxUnavailable" placeholder="1" />
                    <label>Pod Disruption Budget - Min Available</label
                    ><input name="pdbMinAvailable" placeholder="1" />
                    <label>Pod Disruption Budget Selector (YAML)</label>
                    <textarea
                        name="pdbSelector"
                        placeholder="matchLabels:
  elasticsearch.k8s.elastic.co/cluster-name: quickstart"
                    ></textarea>
                    <label>Update Strategy ChangeBudget - Max Surge</label
                    ><input name="updateMaxSurge" placeholder="1" />
                    <label>Update Strategy ChangeBudget - Max Unavailable</label
                    ><input name="updateMaxUnavailable" placeholder="1" />
                    <label>Remote Cluster Server Enabled</label>
                    <select name="remoteClusterServer">
                        <option value="">-- Select --</option>
                        <option value="true">true</option>
                        <option value="false">false</option>
                    </select>
                    <div id="remoteClusters"></div>
                    <button
                        type="button"
                        class="add-btn"
                        onclick="addRemoteCluster()"
                    >
                        + Add Remote Cluster
                    </button>
                </details>
            </div>
            <div class="container">
                <h2>NodeSets</h2>
                <div id="nodesets-container"></div>
                <button
                    type="button"
                    class="add-btn"
                    onclick='addNodeSet({name:"hot",count:1,roles:["master"],configYaml:""})'
                >
                    + Add NodeSet
                </button>
            </div>
            <div class="container">
                <button type="submit" class="primary">Generate YAML</button>
            </div>
        </form>
        <div class="container" id="yaml-output-container"></div>
    </body>
</html>
